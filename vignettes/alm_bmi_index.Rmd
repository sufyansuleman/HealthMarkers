---
title: "ALM/BMI Index"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{alm_bmi_index}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(purl = FALSE)
```

## Scope
Compute ALM/BMI and flag low muscle mass using FNIH cut-points (men < 0.789; women < 0.512) with optional NA and extreme handling.

## When to use this
- You need a quick sarcopenia risk flag based on ALM relative to body size.
- You have ALM (kg), BMI (kg/m^2), and sex, and want FNIH cut-points applied automatically.
- You want the option to cap implausible ALM/BMI values and control missing-data policy.

## What you need (rich guide)
- Required columns: `alm` (kg), `bmi` (kg/m^2), `sex` (m/f/1/0; other values yield `NA` for the flag).
- Defaults: ALM in kg, BMI in kg/m^2. No unit conversion is performed.
- Policies: `na_action` (`keep`/`warn`/`ignore` behave like keep; `omit` drops; `error` aborts). `check_extreme` + `extreme_action` can cap/NA/error on implausible ALM/BMI.
- FNIH cut-points are built in; nothing to configure beyond column mapping.

## Load packages and data
Use a small subset of the simulated data. Here we derive a simple ALM proxy for illustration.

```{r}
library(HealthMarkers)
library(dplyr)

sim_path <- system.file("extdata", "simulated_hm_data.rds", package = "HealthMarkers")
sim <- readRDS(sim_path)
sim_small <- sim[1:50, ]

# Example proxy for ALM (replace with measured ALM when available)
sim_small <- sim_small |>
  mutate(ALM_kg = pmax(10, pmin(35, weight * 0.35)))
```

## Column map
Map your columns; sex is normalized by first letter (m/f/1/0).

```{r}
col_map <- list(
  alm = "ALM_kg",
  bmi = "BMI",
  sex = "sex"
)
```

## Walkthrough (compute ALM/BMI and flag)

```{r}
alm_out <- alm_bmi_index(
  data = sim_small,
  col_map = col_map,
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)

alm_out |>
  slice_head(n = 5) |>
  select(alm_bmi_ratio, low_muscle_mass)
```

Interpretation: `alm_bmi_ratio` is ALM/BMI. `low_muscle_mass` is `TRUE` if below the sex-specific FNIH cut-point; `NA` if sex or ratio is `NA`.

## Missing data and extremes
Compare NA handling and optional capping.

```{r}
demo <- sim_small[1:8, c("ALM_kg", "BMI", "sex")]
demo$ALM_kg[3] <- NA
demo$BMI[4] <- 2    # implausible, will be capped

alm_keep <- alm_bmi_index(
  data = demo,
  col_map = col_map,
  na_action = "keep",
  check_extreme = TRUE,
  extreme_action = "cap",
  extreme_rules = list(alm = c(5, 40), bmi = c(10, 60)),
  verbose = FALSE
)

alm_omit <- alm_bmi_index(
  data = demo,
  col_map = col_map,
  na_action = "omit",
  check_extreme = TRUE,
  extreme_action = "cap",
  extreme_rules = list(alm = c(5, 40), bmi = c(10, 60)),
  verbose = FALSE
)

list(
  keep_rows = nrow(alm_keep),
  omit_rows = nrow(alm_omit),
  preview = alm_keep |> select(alm_bmi_ratio, low_muscle_mass) |> slice_head(n = 3)
)
```

## Expectations
- Required columns must be mapped; missing columns abort.
- `na_action` controls row handling (`keep`/`warn`/`ignore` behave like keep; `omit` drops; `error` aborts).
- `check_extreme` screens raw ALM/BMI; `extreme_action` can warn/cap/NA/error; tune `extreme_rules` to your lab limits.
- Sex must normalize to m/f/1/0 for the flag to evaluate; otherwise the flag is `NA`.

## Common pitfalls
- Feeding ALM in pounds or BMI in non-metric units will misclassify; keep ALM in kg and BMI in kg/m^2.
- A single implausible BMI (e.g., <=0) zeroes the ratio; enable `check_extreme` to cap or NA such inputs.
- Using an ALM proxy (like weight * 0.35) is illustrative only; use measured ALM when possible.
- `na_action = keep` leaves missing inputs as `NA`; choose `omit` for stricter pipelines.

## Validation notes
- Spot-check one row: ratio = ALM/BMI; compare to FNIH thresholds (0.789 men, 0.512 women) to verify `low_muscle_mass`.
- With `check_extreme = TRUE` and `extreme_action = cap`, ALM/BMI will be truncated into your specified ranges before the ratio.
- Expect `low_muscle_mass` to be `NA` when sex cannot be normalized.

## See also
- `adiposity_sds()` / `adiposity_sds_strat()` for standardizing BMI or related measures.
- `frailty_index()` for a broader frailty construct.
