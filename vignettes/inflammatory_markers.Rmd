---
title: "inflammatory_markers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{inflammatory_markers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`inflammatory_markers()` computes inflammatory ratios/panels. Panels:
- Classic: NLR, PLR, LMR, dNLR, SII, SIRI, AISI, CRP_category.
- Eosinophil: NLR, PLR, LMR, NER, SII, SIRI, PIV, CLR, CAR, PCR, mGPS, ESR passthrough.
- Both: union of classic and eos metrics.
Inputs are coerced to numeric, non-finite become `NA`, zero denominators warn, and optional extreme handling can warn/cap/blank/error on implausible counts.

## Required Inputs

- `data`: data.frame/tibble with blood counts and CRP/albumin (for eos panel).
- `col_map`: named list mapping keys: `neutrophils`, `lymphocytes`, `monocytes`, `platelets`, `WBC`, `CRP`, `albumin`, `eosinophils`, `ESR`. Classic requires at least neutrophils + lymphocytes (monocytes/platelets recommended); eos requires eosinophils plus CRP and albumin.
- Inputs are coerced to numeric; non-finite values set to `NA`.

## Key Arguments

- `panel = c("auto","classic","eos","both")`: `auto` uses eos panel if `eosinophils` key present.
- `na_action = c("error","omit","keep")`: missing-data policy over used inputs (`keep` retains NA outputs; `omit` drops rows; `error` aborts).
- `check_extreme = FALSE`: enable basic plausibility capping/NA/error.
- `extreme_action = c("warn","cap","error","ignore","NA")`: response to extremes when scanning (`cap` truncates to ranges; `NA` blanks values).
- `verbose = FALSE`: emit progress messages.

## Output Description

Returns a tibble with the panel-specific indices. When `na_action = "omit"`, rows with missing required inputs are dropped; otherwise those rows yield `NA` results. Zero denominators emit a warning.

## Minimal Reproducible Example (Classic Panel)

```{r}
library(HealthMarkers)
library(tibble)

df <- tibble(
  neutrophils = c(4, 2), lymphocytes = c(2, 1.5), monocytes = c(0.5, 0.3),
  platelets = c(200, 150), WBC = c(7, 4.5), CRP = c(2.5, 0.8)
)

cm_classic <- list(
  neutrophils = "neutrophils", lymphocytes = "lymphocytes",
  monocytes = "monocytes", platelets = "platelets", WBC = "WBC", CRP = "CRP"
)

inflammatory_markers(
  data = df,
  col_map = cm_classic,
  panel = "classic",
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)
```

## Extended Example (Eosinophil Panel with Extreme Capping)

```{r}
df_eos <- tibble(
  neutrophils = c(4, 2), lymphocytes = c(2, 0.8), monocytes = c(0.5, 0.3),
  platelets = c(200, 150), WBC = c(7, 4.5), CRP = c(2.5, 0.8), albumin = c(40, 42),
  eosinophils = c(0.2, 0.1), ESR = c(12, 15)
)

cm_eos <- list(
  neutrophils = "neutrophils", lymphocytes = "lymphocytes", monocytes = "monocytes",
  platelets = "platelets", WBC = "WBC", CRP = "CRP", albumin = "albumin",
  eosinophils = "eosinophils", ESR = "ESR"
)

inflammatory_markers(
  data = df_eos,
  col_map = cm_eos,
  panel = "eos",
  na_action = "keep",
  check_extreme = TRUE,
  extreme_action = "cap",
  verbose = TRUE
)
```

## Notes / Workflow Integration

- Classic panel requires at least neutrophils and lymphocytes; eos panel also needs eosinophils plus CRP and albumin (for CLR/CAR/mGPS).
- `na_action = "error"` enforces complete inputs; `omit` drops incomplete rows; `keep` retains NA outputs.
- Extreme screening uses built-in broad ranges; `extreme_action` controls warn/cap/NA/error behavior.
- mGPS uses CRP (<=10 vs >10 mg/L) and albumin (>=35 vs <35 g/L); ESR is passed through when mapped.