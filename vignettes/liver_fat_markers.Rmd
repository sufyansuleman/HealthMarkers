---
title: "liver_fat_markers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{liver_fat_markers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(purl = FALSE)
```

## Scope

Compute hepatic steatosis scores HSI and NAFLD_LFS with configurable NA/extreme handling and optional MetS/insulin terms.

## Load packages and data

```{r}
library(HealthMarkers)
library(dplyr)

sim <- readRDS(system.file("extdata/simulated_hm_data.rds", package = "HealthMarkers"))
liver <- sim |>
  mutate(MetS = 0, insulin = I0 / 6, glucose = G0) |>
  select(ALT, AST, BMI, sex, diabetes, MetS, insulin, I0, waist, TG, HDL_c, sbp, bp_sys, bp_treated, glucose, G0)
```

## Column map

- Required: `ALT`, `AST` (U/L), `BMI` (kg/m^2).
- Optional (improves NAFLD_LFS/MetS derivation): `sex` (1/2 or labels), `diabetes`, `MetS`, `insulin` (muU/mL), `I0` (pmol/L; divided by 6 if insulin missing), `waist` (cm), `TG`, `HDL_c` (mmol/L), blood pressure (`sbp` or `bp_sys`, plus `bp_treated`), `glucose`/`G0` (mmol/L).
- Map via `col_map`; numeric-like inputs are coerced and non-finite set to `NA` before policy handling.

## Core calculation

```{r}
liver_out <- liver_fat_markers(
  data = liver,
  col_map = list(
    ALT = "ALT", AST = "AST", BMI = "BMI", sex = "sex", diabetes = "diabetes", MetS = "MetS",
    insulin = "insulin", I0 = "I0", waist = "waist", TG = "TG", HDL_c = "HDL_c",
    sbp = "sbp", bp_sys = "bp_sys", bp_treated = "bp_treated", glucose = "glucose", G0 = "G0"
  ),
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)
liver_out |> slice_head(n = 5)
```

## Missing data & extremes

- `na_action`: `keep/ignore` retain rows with missing inputs (scores become `NA`); `omit` drops them; `error` aborts; `warn` retains with warnings. `na_warn_prop` governs high-missingness warnings when using `warn`.
- `check_extreme` with `extreme_action` (`warn`, `cap`, `NA`, `error`, `ignore`) scans defaults: ALT/AST 0-1000 U/L; BMI 10-80; insulin 0-500 muU/mL; I0 0-3000 pmol/L; TG 0-50; HDL_c 0-10; waist 30-250 cm; SBP 60-300 mmHg; glucose/G0 0-50 mmol/L. Override via `extreme_rules`.
- Insulin term uses `insulin` when present; otherwise `I0/6` (pmol/L to muU/mL). Blood pressure uses `sbp` if provided, else `bp_sys`.

## Expectations

- Outputs: `HSI` and `NAFLD_LFS`.
- HSI adds +2 for female and +2 for diabetes; NAFLD_LFS uses diabetes, MetS (supplied or derived), AST, AST/ALT, and insulin (or I0/6). Missing optional inputs yield `NA` in dependent terms.
- LDL is not used.

## Tips

- Provide waist, TG, HDL_c, blood pressure, and glucose/G0 to allow MetS derivation when `MetS` is not mapped.
- Set `bp_treated` when antihypertensive therapy is present; it affects MetS derivation.
- Use `check_extreme = TRUE` with `cap` to constrain implausible labs/anthropometrics before scoring.
- Choose `na_action = "omit"` when you need complete-case scores for modeling; otherwise keep to preserve row counts.
