---
title: "Metabolic Markers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Metabolic Markers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  message = FALSE,
  warning = FALSE
)
knitr::opts_knit$set(purl = FALSE)
```

## Scope

Aggregate metabolic marker groups (insulin indices, adiposity SDS, cardio, lipid, liver, glycemic, MetS) by delegating to the underlying calculators and binding their outputs to your input data.

## When to use

- You want one call to append several metabolic panels instead of running each function separately.
- You need insulin sensitivity/resistance plus lipid, liver, glycemic, or MetS features with consistent logging.
- You already know the required columns and units for each underlying function; this wrapper does not convert units.

## Inputs

- `data`: data.frame/tibble containing all variables needed by the chosen groups.
- `col_map`: named list reused across groups; include keys required by your `which` selection. Examples: lipids `TC/HDL_c/TG/LDL_c`; liver `BMI/waist/triglycerides/GGT/AST/ALT/platelets/albumin/diabetes/bilirubin/creatinine`; glycemic/insulin `glucose/insulin`; MetS `waist/TG/HDL_c/sbp/dbp`.
- `which`: any of `"insulin"`, `"adiposity_sds"`, `"cardio"`, `"lipid"`, `"liver"`, `"glycemic"`, `"mets"`.
- `normalize`: insulin indices only; one of `none`, `z`, `inverse`, `range`, `robust`.
- `mode`: insulin outputs only; `both`, `IS`, or `IR` (IR are reciprocals of IS).
- `na_action`: `keep`, `omit`, or `error`; forwarded to each calculator.
- `verbose`: log start/skip/completion messages (`TRUE` default in the function).

## Quick start

```{r}
library(HealthMarkers)
library(tibble)

met_df <- tibble(
  TC = c(5.2, 6.1), HDL_c = c(1.3, 1.0), TG = c(1.5, 2.2), LDL_c = c(3.2, 3.6),
  ALT = c(30, 40), AST = c(25, 35), BMI = c(26, 31), waist = c(90, 102),
  glucose = c(5.2, 6.1), insulin = c(60, 95)
)

metabolic_markers(
  data = met_df,
  col_map = list(
    TC = "TC", HDL_c = "HDL_c", TG = "TG", LDL_c = "LDL_c",
    ALT = "ALT", AST = "AST", BMI = "BMI", waist = "waist",
    glucose = "glucose", insulin = "insulin"
  ),
  which = c("lipid","liver","glycemic"),
  normalize = "none",
  mode = "both",
  na_action = "keep",
  verbose = FALSE
)
```

## MetS + insulin with row dropping and logs

```{r}
met_mets <- tibble(
  waist    = c(90, 104, NA),
  TG       = c(1.5, 2.8, 1.9),
  HDL_c    = c(1.3, 0.9, 1.1),
  sbp      = c(120, 138, 142),
  dbp      = c(78, 86, 88),
  glucose  = c(5.2, 6.4, 5.8),
  insulin  = c(60, 105, 70)
)

metabolic_markers(
  data = met_mets,
  col_map = list(
    waist = "waist", TG = "TG", HDL_c = "HDL_c", sbp = "sbp", dbp = "dbp",
    glucose = "glucose", insulin = "insulin"
  ),
  which = c("mets","insulin"),
  normalize = "z",
  mode = "both",
  na_action = "omit",
  verbose = TRUE
)
```

## Handling missingness and extremes

- `na_action` is passed to each underlying function; rows may be dropped (`omit`) or errors thrown (`error`) depending on that functionâ€™s policy.
- Numeric coercion and extreme-value scanning/capping are handled by the underlying calculators; this wrapper does not add bounds or unit conversions.
- Some groups prepare helper columns before delegation (e.g., MetS and liver prep triglycerides aliases); failures are skipped with optional logging when `verbose = TRUE`.

## Expectations

- Returns the original data plus columns from each requested group that passes validation; skipped groups are noted when `verbose = TRUE`.
- Insulin indices bind first (if selected), then the requested groups; `normalize` and `mode` affect insulin only.
- MetS is computed via `metss()` with a fallback when validation fails.

## Tips

- Build a `col_map` that satisfies all selected groups; units must match each underlying function (no conversion here).
- Narrow `which` to only the panels you need, especially on wide datasets.
- Set `verbose = TRUE` to see which groups were added or skipped; use `mode = "IR"` if you only need insulin resistance outputs.
