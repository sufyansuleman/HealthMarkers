---
title: "metss"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{metss}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`metss()` computes the Metabolic Syndrome Severity Score (MetSSS) using sex- and race-specific coefficients (factor-loading style). It validates required inputs, supports NA policies, optional high-missingness warnings, optional extreme screening with warn/cap/NA/error behaviors, and optional diagnostics for plausibility. Units are assumed: waist cm, blood pressure mmHg, TG/HDL_c/glucose mmol/L, sex coded 1=male/2=female, race in {NHW, NHB, HW, HA} or accepted synonyms; no unit conversion is performed.

## Inputs

- `data`: data.frame/tibble with columns `waist`, `bp_sys`, `bp_dia`, `TG`, `HDL_c`, `glucose`, `sex`, `race`.
- `params`: named list of parameter sets keyed by `RACE_SEX` (e.g., `NHW_M`). Each entry contains `intercept` and component vectors (`waist`, `TG`, `HDL`, `glucose`, `MAP`) with `mean`, `sd`, and `coef`.

## Arguments

- `na_action = c("keep","omit","error","ignore","warn")`: missing-data policy (`ignore`/`warn` behave like `keep`; `omit` drops rows; `error` aborts). `na_warn_prop` sets high-missingness threshold when `na_action = "warn"` (default 0.2).
- `check_extreme = FALSE`: enable plausible-range scan (waist 40–200 cm; bp_sys 60–300; bp_dia 30–200; TG 0–20; HDL_c 0–5; glucose 0–40 unless overridden).
- `extreme_action = c("warn","cap","error","ignore","NA")`: handling for extremes when scanning (`cap` truncates; `NA` blanks values).
- `extreme_rules = NULL`: override default extreme ranges.
- `diagnostics = TRUE`: emit additional value/unit sanity warnings (nonnegative, ranges, sex/race validity).
- `verbose = FALSE`: emit progress and completion summaries.

## Output

Returns a tibble with `MetSSS` (numeric). Parameters are chosen using the first row's race/sex key; if multiple keys are present, a warning notes the first key is used for all rows. When `na_action = "omit"`, rows with missing required inputs are removed; otherwise `NA` propagates. Extreme handling can cap or blank inputs before scoring.

## Examples

```{r}
library(HealthMarkers)
library(tibble)

df <- tibble(
  waist = c(95, 108),
  bp_sys = c(120, 138),
  bp_dia = c(80, 86),
  TG = c(1.5, 2.1),
  HDL_c = c(1.2, 0.9),
  glucose = c(5.5, 6.2),
  sex = c(1, 1),
  race = c("NHW", "NHW")
)

metss(
  data = df,
  params = list(
    NHW_M = list(
      intercept = -2.344,
      waist   = c(mean = 94.0, sd = 12.4, coef = 0.846),
      TG      = c(mean = 1.5,  sd = 0.6,  coef = 0.701),
      HDL     = c(mean = 1.1,  sd = 0.3,  coef = -0.663),
      glucose = c(mean = 5.3,  sd = 0.6,  coef = 0.658),
      MAP     = c(mean = 97,   sd = 11,   coef = 0.466)
    )
  ),
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)
```

## Examples

Enable extreme screening with capping, plus diagnostics and verbose output:

```{r}
metss(
  data = df,
  params = list(
    NHW_M = list(
      intercept = -2.344,
      waist   = c(mean = 94.0, sd = 12.4, coef = 0.846),
      TG      = c(mean = 1.5,  sd = 0.6,  coef = 0.701),
      HDL     = c(mean = 1.1,  sd = 0.3,  coef = -0.663),
      glucose = c(mean = 5.3,  sd = 0.6,  coef = 0.658),
      MAP     = c(mean = 97,   sd = 11,   coef = 0.466)
    )
  ),
  na_action = "warn",
  check_extreme = TRUE,
  extreme_action = "cap",
  diagnostics = TRUE,
  verbose = TRUE
)
```

## Notes

- Sex coding must be 1/2; race keys map accepted synonyms (NHW/WHITE, NHB/BLACK, HW/HISPANIC/H/L, HA/ASIAN). First-row key is used for all rows.
- Mean/sd/coef in `params` define standardization and loadings; verify they match your cohort/score version.
- Diagnostics flag nonpositive/negative values and out-of-range BP; extreme handling is optional and separate.
- `na_action = "omit"` filters rows; otherwise missing inputs propagate `NA` to `MetSSS`.
