---
title: "hormone_markers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{hormone_markers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`hormone_markers()` computes nine hormone ratios with QA options: FAI, LH_FSH, E2_P, T3_T4, ARR, Ins_Glu, GH_IGF1, PRL_T, and CAR_slope. Inputs are coerced to numeric, non-finite values become `NA`, and optional extreme screening can warn, cap, blank, or error on out-of-range labs.

## Required Inputs

- `data`: data.frame/tibble with hormone labs.
- `col_map`: named list mapping required keys to column names (all required): `total_testosterone`, `SHBG`, `LH`, `FSH`, `estradiol`, `progesterone`, `free_T3`, `free_T4`, `aldosterone`, `renin`, `insulin`, `glucagon`, `GH`, `IGF1`, `prolactin`, `cortisol_0`, `cortisol_30`.
- Inputs are coerced to numeric; non-finite values are set to `NA` before calculation.

## Key Arguments

- `na_action = c("ignore","warn","error","keep","omit")`: missing-data policy (`keep` == `ignore`; `omit` drops rows with any missing required inputs).
- `na_warn_prop = 0.2`: high-missingness warning threshold when `na_action = "warn"`.
- `check_extreme = FALSE`: enable plausible-range scan.
- `extreme_action = c("warn","cap","error","ignore","NA")`: response to extremes when scanning (`cap` truncates to bounds; `NA` blanks values).
- `extreme_rules = NULL`: override default broad bounds per hormone.
- `verbose = FALSE`: emit progress and NA counts.

## Output Description

Returns a tibble with columns `FAI`, `LH_FSH`, `E2_P`, `T3_T4`, `ARR`, `Ins_Glu`, `GH_IGF1`, `PRL_T`, `CAR_slope`. Rows are dropped only when `na_action = "omit"`; otherwise missing inputs yield `NA` outputs.

## Minimal Reproducible Example

```{r}
library(HealthMarkers)
library(tibble)

labs <- tibble(
  tt = c(5, 7), shbg = c(30, 40), lh = c(6, 7), fsh = c(8, 9),
  e2 = c(120, 140), p4 = c(2, 3), ft3 = c(4.5, 4.8), ft4 = c(16, 15),
  aldo = c(150, 120), renin = c(12, 10), ins = c(15, 20), gluc = c(80, 70),
  gh = c(1.2, 0.9), igf1 = c(180, 160), prl = c(10, 12), cort0 = c(300, 280), cort30 = c(480, 450)
)

hormone_markers(
  data = labs,
  col_map = list(
    total_testosterone = "tt", SHBG = "shbg", LH = "lh", FSH = "fsh",
    estradiol = "e2", progesterone = "p4", free_T3 = "ft3", free_T4 = "ft4",
    aldosterone = "aldo", renin = "renin", insulin = "ins", glucagon = "gluc",
    GH = "gh", IGF1 = "igf1", prolactin = "prl", cortisol_0 = "cort0", cortisol_30 = "cort30"
  ),
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)
```

## Extended Example

Drop rows with missing inputs, scan for extremes, and cap into allowed ranges:

```{r}
hormone_markers(
  data = labs,
  col_map = list(
    total_testosterone = "tt", SHBG = "shbg", LH = "lh", FSH = "fsh",
    estradiol = "e2", progesterone = "p4", free_T3 = "ft3", free_T4 = "ft4",
    aldosterone = "aldo", renin = "renin", insulin = "ins", glucagon = "gluc",
    GH = "gh", IGF1 = "igf1", prolactin = "prl", cortisol_0 = "cort0", cortisol_30 = "cort30"
  ),
  na_action = "omit",
  check_extreme = TRUE,
  extreme_action = "cap",
  verbose = TRUE
)
```

## Notes / Workflow Integration

- Required keys must all be mapped; missing mappings or columns abort.
- `na_action = "error"` enforces complete inputs; `"omit"` filters; `"ignore"`/`"keep"` retain rows with NA outputs.
- Extreme screening uses broad defaults; customize `extreme_rules` for tighter lab ranges or choose `extreme_action` behavior.
- CAR_slope uses a 30-minute delta `(cortisol_30 - cortisol_0) / 30`.