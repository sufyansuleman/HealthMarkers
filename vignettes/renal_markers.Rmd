---
title: "renal_markers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{renal_markers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`renal_markers()` computes renal function, injury, and excretion metrics from routine labs. It includes CKD-EPI 2009 creatinine eGFR (race factor retained), optional cystatin C and combined equations, BUN/Cr ratio, fractional excretion of urea (FE_Urea), and pass-through urine injury markers (NGAL, KIM1, NAG, Beta2Micro, IL18, L_FABP). Inputs are validated, required fields can be coerced to numeric with warnings, missingness is handled per policy, zero denominators are detected and warned, and optional extreme-value scanning/capping is available. No unit conversion is performed; supply measurements in expected units.

## Inputs

- `data`: data.frame/tibble containing renal labs.
- `col_map`: named list mapping required keys and any optional markers:
  - Required: `creatinine` (serum Cr, mg/dL), `age` (years), `sex` (1 male / 0 female or "male"/"female"), `race` ("white"/"black"/"other" aliases accepted), `BUN` (mg/dL).
  - Optional for eGFR/FEUrea: `cystatin_C` (mg/L), `urea_serum` (mg/dL), `creatinine_urine` (mg/dL), `urea_urine` (mg/dL).
  - Optional injury markers: `NGAL`, `KIM1`, `NAG`, `beta2_micro`, `IL18`, `L_FABP` (pass-through if mapped).
Required mapped columns must exist in `data`; numeric-required columns are coerced when possible, introducing `NA` with warnings when coercion fails.

## Arguments

- `na_action = c("keep","omit","error")`: policy for missing required inputs (propagate NA, drop rows, or abort).
- `na_warn_prop = 0.2`: proportion threshold for high-missingness diagnostics on required inputs (debug level).
- `check_extreme = FALSE`: scan selected inputs for out-of-range values using simple bounds.
- `extreme_action = c("warn","cap","error","ignore")`: response to detected extremes; `cap` truncates to bounds and warns.
- `extreme_rules = NULL`: optional named list of c(min,max) overrides for extreme scanning; defaults include ranges for creatinine, BUN, cystatin_C, urea_serum, creatinine_urine, urea_urine.
- `verbose = FALSE`: emit progress, omission counts, and completion diagnostics.

## Output

Returns a tibble with columns:
- `eGFR_cr`, `eGFR_cys`, `eGFR_combined`: CKD-EPI 2009 creatinine, cystatin C, and combined equations (cystatin-dependent outputs are `NA` when `cystatin_C` is absent).
- `BUN_Cr_ratio`: blood urea nitrogen / creatinine; zero or non-finite denominators yield `NA` with a consolidated warning.
- `FE_Urea`: fractional excretion of urea (%) when `urea_serum`, `creatinine_urine`, and `urea_urine` are all mapped; otherwise `NA`.
- `NGAL`, `KIM1`, `NAG`, `Beta2Micro`, `IL18`, `L_FABP`: pass-through injury markers when provided; otherwise `NA`.

## Examples

```{r}
library(HealthMarkers)
library(tibble)

df <- tibble(
  Cr = c(1.0, 1.3),
  Age = c(40, 72),
  Sex = c(1, 0),      # 1 = male, 0 = female
  Race = c("white", "black"),
  BUN = c(14, 22)
)

cm <- list(
  creatinine = "Cr",
  age = "Age",
  sex = "Sex",
  race = "Race",
  BUN = "BUN"
)

renal_markers(
  data = df,
  col_map = cm,
  na_action = "keep",
  verbose = FALSE
)
```

## Examples

Include cystatin C and urea inputs, enable extreme scanning with capping, and map one injury marker:

```{r}
df2 <- tibble(
  Cr = c(0.9, 2.2, 18),        # extreme creatinine will be capped when requested
  Age = c(55, 68, 50),
  Sex = c("male", "female", "male"),
  Race = c("white", "other", "black"),
  BUN = c(16, 40, 210),        # extreme BUN for demonstration
  Cys = c(1.0, 1.4, 0.6),
  UreaS = c(28, 35, 18),
  CrU = c(120, 95, 80),
  UreaU = c(480, 520, 300),
  NGAL = c(20, 35, 15)
)

cm2 <- list(
  creatinine = "Cr",
  age = "Age",
  sex = "Sex",
  race = "Race",
  BUN = "BUN",
  cystatin_C = "Cys",
  urea_serum = "UreaS",
  creatinine_urine = "CrU",
  urea_urine = "UreaU",
  NGAL = "NGAL"
)

renal_markers(
  data = df2,
  col_map = cm2,
  check_extreme = TRUE,
  extreme_action = "cap",
  na_action = "keep",
  verbose = TRUE
)
```

## Notes

- Units are assumed: serum creatinine and BUN in mg/dL; cystatin C in mg/L; serum/urine urea and urine creatinine in mg/dL. No automatic conversion is performed.
- Race factor follows CKD-EPI 2009 (race-dependent) to preserve existing behavior; race-free variants are not applied here.
- Sex mapping accepts 1/0, 2/0, or "male"/"female" variants; unmapped values warn and become `NA`.
- Race mapping normalizes common aliases to `"white"`, `"black"`, or `"other"`; unknown values default to `"other"`.
- When `na_action = "error"`, any missing required input aborts; `omit` drops those rows; `keep` propagates `NA`.
- Zero denominators in ratio calculations yield `NA` and trigger a consolidated warning naming affected metrics.
- Extreme scanning uses built-in bounds unless `extreme_rules` is supplied; `extreme_action = "cap"` truncates values into those ranges and warns.
- High missingness on required columns is reported at debug level; use `verbose = TRUE` to view diagnostics and completion summaries.

