---
title: "Glycemic and metabolic markers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{glycemic_markers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(purl = FALSE)
```

## Scope
Compute SPISE, METS_IR, prediabetes/diabetes flags (HbA1c), HOMA_CP, LAR, ASI, and TyG_index from fasting labs and anthropometry. Required inputs: HDL_c (mmol/L), TG (mmol/L), BMI (kg/m^2); optional glucose/HbA1c/C-peptide/insulin/leptin/adiponectin if present. Uses the packaged simulated data for runnable examples.

## When to use
- You have fasting lipids and BMI and want quick insulin resistance/sensitivity proxies.
- You can supply glucose/HbA1c/C-peptide/insulin/adipokines when available to enrich outputs.
- You need explicit NA handling and optional extreme-value screening.

## Inputs and requirements
- Required (mapped via `col_map`): `HDL_c` (mmol/L), `TG` (mmol/L), `BMI` (kg/m^2).
- Optional: `glucose`, `HbA1c`, `C_peptide`, `G0`, `I0`, `leptin`, `adiponectin`.
- Unit notes: TyG converts TG to mg/dL (x88.57) and glucose to mg/dL (x18); HOMA_CP uses `(G0 * (C_peptide/6)) / 22.5`.
- `na_action`: `keep`/`ignore`/`warn` retain rows with NA outputs; `omit` drops rows with missing used inputs; `error` aborts.
- `check_extreme`: when TRUE, scans inputs with default broad ranges; `extreme_action` = `warn`/`cap`/`NA`/`error`/`ignore`.

## Load packages and data
Use a small subset of the simulated data (30-50 rows). Swap `sim_small` with your data frame in practice.

```{r}
library(HealthMarkers)
library(dplyr)

sim_path <- system.file("extdata", "simulated_hm_data.rds", package = "HealthMarkers")
sim <- readRDS(sim_path)
sim_small <- sim[1:50, ]
```

## Column map (required)
Map required and optional inputs to your column names; left-hand keys are fixed.

### What each input represents
- `HDL_c`: HDL cholesterol (mmol/L)  required
- `TG`: triglycerides (mmol/L)  required
- `BMI`: body mass index (kg/m^2)  required
- `glucose`: fasting glucose (mmol/L)
- `HbA1c`: hemoglobin A1c (mmol/mol)
- `C_peptide`: C-peptide (pmol/L)
- `G0`: fasting glucose (mmol/L) for HOMA_CP
- `I0`: fasting insulin (pmol/L) for ASI
- `leptin`: leptin (ng/mL)
- `adiponectin`: adiponectin (ng/mL)

```{r}
col_map <- list(
  HDL_c = "HDL_c",
  TG = "TG",
  BMI = "BMI",
  glucose = "glucose",
  HbA1c = "HbA1c",
  C_peptide = "C_peptide",
  G0 = "G0",
  I0 = "I0",
  leptin = "leptin",
  adiponectin = "adiponectin"
)
```

## Core calculation
Compute all markers and show only newly created columns.

```{r}
gm <- glycemic_markers(
  data = sim_small,
  col_map = col_map,
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)

gm_new <- setdiff(names(gm), names(sim_small))
head(select(gm, all_of(gm_new)))
```

Interpretation: SPISE and METS_IR summarize insulin sensitivity/resistance; TyG_index rises with higher TG/glucose; HOMA_CP approximates insulin resistance via C-peptide and glucose; LAR and ASI relate adipokines to insulin; HbA1c flags populate `prediabetes`/`diabetes` when available. Rows are retained here because `na_action = "keep"`.

## Inputs and units (quick reminder)
- Required: `HDL_c` (mmol/L), `TG` (mmol/L), `BMI` (kg/m^2).
- Optional if present/mapped: `glucose`, `HbA1c`, `C_peptide`, `G0`, `I0`, `leptin`, `adiponectin`.
- TyG converts TG to mg/dL (88.57) and glucose to mg/dL (18) internally.
- HOMA_CP uses `(G0 * (C_peptide/6)) / 22.5`; verify your units for C-peptide.
- Missingness: `na_action` controls row handling (`keep`/`omit`/`error`/`warn`/`ignore`).
- Extreme screening: `check_extreme = TRUE` can warn/cap/NA/error using default broad ranges; override via `extreme_rules`.

## Missing data and extremes
Show row handling and extreme screening on a tiny slice.

```{r}
demo <- sim_small[1:6, c("HDL_c", "TG", "BMI")]
demo$glucose <- c(5.5, 6.2, 7.0, 5.8, 6.0, 5.4)
demo$HbA1c <- c(42, 39, 41, 45, 44, 40)
demo$C_peptide <- c(300, 450, 500, 400, 380, 360)
demo$G0 <- demo$glucose
demo$I0 <- c(60, 90, 120, 80, 75, 70)
demo$leptin <- c(10, 12, 15, 11, 9, 13)
demo$adiponectin <- c(8, 7, 6, 9, 10, 7)
demo$TG[3] <- 30       # extreme TG
demo$HbA1c[2] <- NA    # missing HbA1c

gm_keep <- glycemic_markers(
  data = demo,
  col_map = col_map,
  na_action = "keep",
  check_extreme = TRUE,
  extreme_action = "cap",
  verbose = FALSE
)

gm_omit <- glycemic_markers(
  data = demo,
  col_map = col_map,
  na_action = "omit",
  check_extreme = TRUE,
  extreme_action = "cap",
  verbose = FALSE
)

list(
  keep_rows = nrow(gm_keep),
  omit_rows = nrow(gm_omit),
  capped_preview = head(select(gm_keep, all_of(gm_new)))
)
```

`na_action = "keep"` preserves all rows (missing inputs flow to `NA` outputs); `na_action = "omit"` drops rows with missing/invalid used inputs. `extreme_action = "cap"` trims out-of-range values (e.g., TG = 30) before computation.

## Expectations
- Required inputs must be present/mapped; missing required columns abort.
- `na_action` governs whether missing/invalid inputs drop rows, warn, or error.
- `check_extreme`/`extreme_action` can cap, blank, warn, or abort on out-of-range inputs.
- Optional columns drive optional markers; absent inputs yield `NA` in their markers.

## Tips
- Start with fasting lipids and BMI; add glucose/HbA1c/C-peptide/insulin/adipokines when available for richer markers.
- Convert units beforehand if your data are not in the expected mmol/L/pmol/L/ng/mL units.
- For stricter pipelines, use `na_action = "omit"` or `"error"`; keep/warn for exploratory work.
- Turn on `check_extreme = TRUE` with `extreme_action = "cap"` when working with noisy or simulated inputs.
- See `?glycemic_markers` for full argument details and marker definitions.
