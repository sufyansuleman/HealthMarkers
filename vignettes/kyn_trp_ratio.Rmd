---
title: "kyn_trp_ratio"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{kyn_trp_ratio}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`kyn_trp_ratio()` computes the kynurenine/tryptophan ratio (KTR), a marker of IDO activity and immune activation. It supports NA policies, optional extreme screening with warn/cap/NA/error behaviors, and verbose progress messages. Inputs must already be in Kyn (nmol/L) and Trp (µmol/L); no unit conversion is performed.

## Inputs

- `data`: data.frame/tibble with kynurenine and tryptophan concentrations.
- `col_map`: named list mapping `kynurenine` and `tryptophan` (defaults: `Kyn_nM`, `Trp_uM`). Both mappings are required and the columns must exist.
- Numeric columns are required; non-numeric inputs are coerced with warnings if NAs are introduced.

## Arguments

- `na_action = c("keep","omit","error","ignore","warn")`: missing-data policy (`ignore`/`warn` behave like `keep`; `omit` drops rows; `error` aborts).
- `check_extreme = FALSE`: enable plausible-range scan.
- `extreme_action = c("warn","cap","error","ignore","NA")`: handling for extremes when scanning (`cap` truncates; `NA` blanks values).
- `extreme_rules = NULL`: override defaults `kynurenine_nmolL = c(100, 20000)`, `tryptophan_umolL = c(10, 150)`, `ratio = c(0, 200)`.
- `verbose = FALSE`: emit progress/informational messages.

## Output

Returns a tibble with `kyn_trp_ratio` (numeric). When `na_action = "omit"`, rows with missing inputs are removed; otherwise ratios for those rows are `NA`. Optional extreme handling can warn, cap, blank, or error on out-of-range inputs.

## Examples

```{r}
library(HealthMarkers)
library(tibble)

df <- tibble(
  Kyn_nM = c(1800, 2500, 3200),
  Trp_uM = c(50, 42, 12)
)

kyn_trp_ratio(
  data = df,
  col_map = list(kynurenine = "Kyn_nM", tryptophan = "Trp_uM"),
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)
```

## Examples

Scan for extremes and cap into defaults while warning:

```{r}
kyn_trp_ratio(
  data = df,
  col_map = list(kynurenine = "Kyn_nM", tryptophan = "Trp_uM"),
  na_action = "warn",
  check_extreme = TRUE,
  extreme_action = "cap",
  verbose = TRUE
)
```

## Notes

- Trp must be positive; nonpositive values are set to `NA` with a warning.
- Very high ratios (>100) trigger a warning to re-check units (expect Kyn nmol/L, Trp µmol/L).
- Use `extreme_rules` to tighten/relax bounds for cohort-specific ranges.
- `ignore` and `warn` map to `keep` for NA handling; only `omit` removes rows and `error` aborts.
