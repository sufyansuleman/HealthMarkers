---
title: "nutrient_markers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{nutrient_markers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`nutrient_markers()` computes a panel of nutrient-related ratios/products: FerritinTS, AGR, Omega3Index, Mg_Cr_Ratio, GlycatedAlbuminPct, UA_Cr_Ratio, BUN_Cr_Ratio, Ca_x_Phosphate, AnionGap, and Tyr_Phe_Ratio. It supports NA policies, optional high-missingness diagnostics, optional extreme screening with warn/cap/NA/error behaviors, and verbose summaries. No unit conversion is performed; inputs must already be in expected units.

## Inputs

- `data`: data.frame/tibble containing any subset of the recognized inputs; markers with missing inputs return `NA`.
- `col_map`: optional named list mapping keys (defaults to identity) among: `ferritin`, `transferrin_sat`, `albumin`, `total_protein`, `EPA`, `DHA`, `Mg`, `creatinine`, `glycated_albumin`, `uric_acid`, `BUN`, `phosphate`, `calcium`, `Na`, `K`, `Cl`, `HCO3`, `Tyr`, `Phe`. Unrecognized keys are ignored.
- Numeric columns are required for mapped inputs; non-numeric are coerced with warnings if NAs are introduced; non-finite set to `NA`.

## Arguments

- `na_action = c("keep","omit","error")`: missing-data policy on used inputs (`omit` drops rows; `error` aborts; `keep` propagates `NA`).
- `na_warn_prop = 0.2`: threshold for high-missingness diagnostics (debug-level messaging).
- `check_extreme = FALSE`: enable plausible-range scan.
- `extreme_action = c("warn","cap","error","ignore","NA")`: handling for extremes when scanning (`cap` truncates; `NA` blanks values).
- `extreme_rules = NULL`: override broad defaults (e.g., ferritin 0–2000 ng/mL, transferrin_sat 0–100%, albumin 10–60 g/L, total_protein 40–100 g/L, EPA/DHA 0–20%, Mg 0.2–3 mmol/L, creatinine 20–2000 umol/L, glycated_albumin 0–60 g/L, uric_acid 50–1000 umol/L, BUN 1–150 mg/dL, phosphate 0.1–5 mmol/L, calcium 0.5–4 mmol/L, Na 100–200, K 2–8, Cl 70–130, HCO3 5–45 mmol/L, Tyr 10–300 umol/L, Phe 20–300 umol/L).
- `verbose = FALSE`: emit progress and completion summaries.

## Output

Returns a tibble with the marker columns listed above. Division operations warn on zero denominators. When `na_action = "omit"`, rows with missing used inputs are removed; otherwise those rows yield `NA` outputs. Extreme handling can cap or blank inputs before calculation.

## Examples

```{r}
library(HealthMarkers)
library(tibble)

df <- tibble(
  ferritin = c(50, 100), transferrin_sat = c(30, 50),
  albumin = c(45, 40), total_protein = c(70, 75),
  EPA = c(2.0, 2.5), DHA = c(4.0, 4.5),
  Mg = c(0.85, 0.90), creatinine = c(80, 90),
  glycated_albumin = c(12, 14), uric_acid = c(300, 400), BUN = c(14, 16),
  phosphate = c(1.0, 1.2), calcium = c(2.3, 2.4),
  Na = c(140, 138), K = c(4.2, 4.0), Cl = c(100, 102), HCO3 = c(24, 26),
  Tyr = c(60, 70), Phe = c(50, 55)
)

nutrient_markers(
  data = df,
  col_map = NULL,
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)
```

## Examples

Scan for extremes and cap while warning; drop rows with missing inputs:

```{r}
nutrient_markers(
  data = df,
  col_map = NULL,
  na_action = "omit",
  check_extreme = TRUE,
  extreme_action = "cap",
  verbose = TRUE
)
```

## Notes

- Markers compute only when their inputs are present; others return `NA` silently.
- Omega3Index is EPA + DHA (%) and assumes red-cell fatty acid percentages.
- AGR uses globulin = total_protein - albumin; zero denominators are warned and yield `NA`.
- Adjust `extreme_rules` to match your lab reference ranges; defaults are broad sanity checks.
