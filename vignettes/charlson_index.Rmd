---
title: "charlson_index"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{charlson_index}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`charlson_index()` sums weighted comorbidities for the 19-condition Charlson Comorbidity Index (CCI). It applies max-weight logic to paired conditions (diabetes, liver disease, cancer) to avoid double counting. Age points are not included.

Weights:
- 1 point: MI, CHF, PVD, stroke, dementia, COPD, rheumatologic disease, peptic ulcer
- 2 points: hemiplegia/paraplegia, renal disease, any malignancy (non-metastatic), leukemia, lymphoma, diabetes with complications
- 3 points: moderate/severe liver disease
- 6 points: metastatic solid tumor, HIV/AIDS

## Inputs

- `data`: data.frame/tibble with binary indicators (0/1) for all conditions.
- `col_map`: named list mapping keys to columns: `mi`, `chf`, `pvd`, `stroke`, `dementia`, `copd`, `rheum`, `ulcer`, `mild_liver`, `diabetes`, `diab_comp`, `hemiplegia`, `renal`, `cancer`, `leukemia`, `lymphoma`, `sev_liver`, `metastatic_cancer`, `hiv`.
- Inputs are coerced to numeric; non-finite values become NA. Non-binary values trigger a warning.

## Arguments

- `na_action = c("keep","omit","error","ignore","warn")`: missing-data policy (`ignore`/`warn` behave like `keep`).
- `check_extreme = FALSE`: enable bounds screening (defaults 0–1 for all indicators).
- `extreme_action = c("warn","cap","error","ignore","NA")`: response to out-of-bounds values when screening is on (`cap` trims to bounds; `NA` blanks values).
- `extreme_rules = NULL`: optional custom bounds per key.
- `verbose = FALSE`: emit progress messages.

## Output

Returns a tibble with `charlson_index` (integer total). With `na_action = "omit"`, rows missing any required indicator are dropped; otherwise those rows yield `NA` scores.

## Examples

```{r}
library(HealthMarkers)
library(tibble)

patient <- tibble(
  mi=0, chf=0, pvd=0, stroke=0, dementia=0, copd=0, rheum=0, ulcer=0,
  mild_liver=0, diabetes=0, diab_comp=1, hemiplegia=0, renal=1,
  cancer=0, leukemia=0, lymphoma=0, sev_liver=0, metastatic_cancer=0, hiv=0
)

cm <- as.list(stats::setNames(names(patient), names(patient)))

charlson_index(
  data = patient,
  col_map = cm,
  na_action = "keep",
  check_extreme = FALSE,
  extreme_action = "warn",
  verbose = FALSE
)
```

## Examples

Drop rows with missing indicators, screen for non-binary values, and cap into 0/1 bounds:

```{r}
charlson_index(
  data = patient,
  col_map = cm,
  na_action = "omit",
  check_extreme = TRUE,
  extreme_action = "cap",
  verbose = FALSE
)
```

## Notes

- All 19 condition mappings must be provided; missing any key aborts.
- Non-binary inputs warn; set `check_extreme = TRUE` with `extreme_action` to cap/blank/error on out-of-bounds values (defaults assume 0–1).
- `na_action = "error"` enforces complete indicators; `"omit"` drops incomplete rows; `"keep"`/`"warn"`/`"ignore"` retain rows with `NA` scores.
- Age points are not included; add age separately if needed.

