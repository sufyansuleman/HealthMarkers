---
title: "CVD Risk QRISK3"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cvd_risk_qrisk3}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(purl = FALSE)
```

## Scope
Run the UK QRISK3 10-year calculator with guarded optional dependency loading. Returns `risk = NA` if the backend errors or inputs are incomplete.

## When to use
- You need QRISK3-2017 10-year CVD risk for UK populations.
- You have the required clinical/demographic fields expected by `QRISK3::QRISK3_2017()`.
- You can install the suggested package `QRISK3` (execution is skipped otherwise).

## Inputs and requirements
- `data`: data.frame/tibble with QRISK3-required columns (age, sex/gender, smoking status, comorbidities, BP, lipids, etc.).
- `patid`: optional patient ID vector; if absent, wrapper uses `patid` column when present, otherwise `1:nrow(data)`.
- Units: follow `QRISK3::QRISK3_2017()` conventions (e.g., mmHg for BP, kg/m^2 BMI inputs if used via weight/height).
- NA handling: backend determines validity; wrapper returns `risk = NA` on backend error.

## Load packages and data
Use 30 simulated rows and let the wrapper auto-assign `patid`.

```{r}
library(HealthMarkers)
library(dplyr)

sim_path <- system.file("extdata", "simulated_hm_data.rds", package = "HealthMarkers")
sim <- readRDS(sim_path)
sim_small <- sim[1:30, ]
```

## QRISK3 risk
Execute only when `QRISK3` is available.

```{r eval = requireNamespace("QRISK3", quietly = TRUE)}
qrisk_out <- cvd_risk_qrisk3(
  data = sim_small,
  verbose = FALSE
)

head(qrisk_out)
```

## Tips
- Requires the suggested package `QRISK3`; when absent, chunks are skipped and the function aborts with an informative error.
- The wrapper auto-adds `patid` when missing and returns `risk = NA` if the backend errors.
- Provide UK-specific variables per `QRISK3::QRISK3_2017()` (e.g., Townsend score, comorbidity flags, BP, cholesterol/HDL ratio).
- Use `verbose = TRUE` for a brief input receipt message; deeper validation is deferred to the backend to avoid duplicating its spec.
- You can also call via `cvd_risk(model = "QRISK3")`.
