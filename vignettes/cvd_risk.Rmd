---
title: "CVD Risk Dispatcher"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cvd_risk}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(purl = FALSE)
```

## Scope
Dispatch to cardiovascular risk calculators and lipid markers via a single entry point. Supports `model` = `ASCVD`, `QRISK3`, `Stroke`, `RiskScorescvd`, `AIP`, `LDL_PN`, or `ALL` (runs them sequentially).

## When to use
- You want a single API to compute one or many CVD risks/markers.
- You are comfortable installing optional Suggests packages for the calculators you need (PooledCohort, QRISK3, RiskScorescvd).
- You want graceful fallback: `model = "ALL"` returns NA placeholders for calculators whose dependencies or inputs fail.

## Inputs and requirements
- `data`: a data.frame/tibble containing the columns required by the selected model(s).
- `model`: one of `ASCVD`, `QRISK3`, `Stroke`, `RiskScorescvd`, `AIP`, `LDL_PN`, or `ALL`.
- `year`: only used by ASCVD/Stroke (10 or 30 for ASCVD; 10 for Stroke).
- `...`: forwarded to the underlying calculator (e.g., `col_map`, `na_action` for lipid markers; backend-specific args otherwise).
- Units: follow each calculator’s expectations (e.g., mg/dL lipids, mmHg SBP, BMI kg/m^2).

## Load packages and data
Use a 30-row slice of the simulated data for the examples. We demonstrate lipid markers (no optional packages required) and guarded runs for optional calculators.

```{r}
library(HealthMarkers)
library(dplyr)

sim_path <- system.file("extdata", "simulated_hm_data.rds", package = "HealthMarkers")
sim <- readRDS(sim_path)
sim_small <- sim[1:30, ]
```

## Lipid markers (no optional packages)
Compute AIP and LDL particle number (ApoB proxy).

```{r}
aip_out <- cvd_risk(
  data = sim_small,
  model = "AIP",
  col_map = list(TG = "TG", HDL_c = "HDL_c"),
  na_action = "keep"
)

ldlpn_out <- cvd_risk(
  data = sim_small,
  model = "LDL_PN",
  col_map = list(ApoB = "ApoB"),
  na_action = "keep"
)

list(
  aip_head = head(aip_out),
  ldlpn_head = head(ldlpn_out)
)
```

## Optional risk calculators
The code below runs only if each required package is available.

```{r eval=requireNamespace("PooledCohort", quietly = TRUE)}
ascvd10 <- cvd_risk(sim_small, model = "ASCVD", year = 10)
stroke10 <- cvd_risk(sim_small, model = "Stroke", year = 10)
head(bind_rows(ascvd10, stroke10))
```

```{r eval=requireNamespace("QRISK3", quietly = TRUE)}
qrisk10 <- cvd_risk(sim_small, model = "QRISK3")
head(qrisk10)
```

```{r eval=requireNamespace("RiskScorescvd", quietly = TRUE)}
rs_out <- cvd_risk(sim_small, model = "RiskScorescvd")
head(rs_out)
```

## Outputs
- Each model returns a tibble; `model = "ALL"` row-binds results and substitutes `NA` rows for models that fail validation or lack optional packages.
- Lipid markers accept `na_action` (keep/omit/error) via `...`; risk calculators rely on their backend behavior.

## Tips
- Install optional packages: PooledCohort (ASCVD, Stroke), QRISK3, RiskScorescvd. Without them, guarded chunks skip and `model = "ALL"` yields `NA` placeholders.
- Ensure required columns match each model’s spec; units follow backend expectations (e.g., mg/dL lipids, mmHg SBP, BMI kg/m^2).
- Use `verbose = TRUE` to surface simple quality scans where supported (ASCVD/Stroke) and to get dispatch messages.
