---
title: "bone_markers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{bone_markers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`bone_markers()` computes DXA-derived and osteoporosis screening metrics: OSTA, ALMI, FMI, and BMD_Tscore (using supplied reference means/SDs). It can also pass through optional turnover/structural markers (TBS, HSA, PINP, CTX, BSAP, Osteocalcin) when mapped. Inputs are coerced to numeric; non-finite become `NA`.

## Inputs

- `data`: data.frame/tibble with DXA and anthropometry.
- `col_map`: named list with required `age`, `weight`, `height`, `ALM`, `FM`, `BMD`, `BMD_ref_mean`, `BMD_ref_sd`.
- Optional keys (passed through if present): `TBS`, `HSA`, `PINP`, `CTX`, `BSAP`, `Osteocalcin`.
- Units: height m; weight/ALM/FM kg; BMD g/cm^2; ALMI/FMI kg/m^2.

## Arguments

- `na_action = c("keep","omit","error")`: handling when required inputs are missing/non-finite.
- `check_extreme = FALSE`: enable SDS-like scan on mapped keys containing "sds" (case-insensitive).
- `sds_limit = 6`: absolute-value limit for SDS-like scan.
- `extreme_action = c("cap","NA","error")`: response to SDS-like extremes (`cap` trims to +/- `sds_limit`; `NA` blanks values).
- `verbose`: emit progress messages.

## Output

Returns a tibble with `OSTA`, `ALMI`, `FMI`, `BMD_Tscore`, followed by any optional markers mapped and present (`TBS`, `HSA`, `PINP`, `CTX`, `BSAP`, `Osteocalcin`). Rows drop only when `na_action = "omit"`; otherwise missing required inputs propagate `NA`.

## Examples

```{r}
library(HealthMarkers)
library(tibble)

bone_df <- tibble(
  age = c(60, 72), weight = c(65, 50), height = c(1.65, 1.58),
  ALM = c(18.2, 14.7), FM = c(22.0, 20.5),
  BMD = c(0.95, 0.80), BMD_ref_mean = c(1.00, 1.00), BMD_ref_sd = c(0.12, 0.12)
)

col_map <- list(
  age = "age", weight = "weight", height = "height",
  ALM = "ALM", FM = "FM", BMD = "BMD",
  BMD_ref_mean = "BMD_ref_mean", BMD_ref_sd = "BMD_ref_sd"
)

bone_markers(
  data = bone_df,
  col_map = col_map,
  na_action = "keep",
  check_extreme = FALSE,
  sds_limit = 6,
  extreme_action = "cap"
)
```

## Examples

Include turnover markers, drop incomplete rows, and cap SDS-like extremes (only keys containing "sds" are scanned):

```{r}
col_map$PINP <- "PINP"
col_map$CTX  <- "CTX"

bone_markers(
  data = bone_df,
  col_map = col_map,
  na_action = "omit",
  check_extreme = TRUE,
  sds_limit = 5,
  extreme_action = "cap"
)
```

## Notes

- Height must be >0 and `BMD_ref_sd` >0; function aborts otherwise.
- SDS-like screening only affects mapped keys whose names contain "sds"; typical inputs are unaffected unless such keys are present.
- Use `na_action = "error"` to enforce complete required inputs; `"omit"` drops incomplete rows; `"keep"` retains rows with `NA` outputs.
- Optional markers are passed through without transformation when mapped and present in `data`.

