---
title: "lipid_markers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{lipid_markers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(purl = FALSE)
```

## Scope

Compute lipid ratios and composite indices (non-HDL-C, remnant-C, TC/HDL, TG/HDL, LDL/HDL, ApoB/ApoA1, VAI, LAP, TyG-BMI) with optional LDL estimation and NA/extreme handling.

## Load packages and data

```{r}
library(HealthMarkers)
library(dplyr)

sim <- readRDS(system.file("extdata/simulated_hm_data.rds", package = "HealthMarkers"))
lipids <- sim |>
  mutate(glucose = G0) |>
  select(TC, HDL_c, TG, LDL_c, ApoB, ApoA1, waist, BMI, glucose)
```

## Column map

- Required: `TC`, `HDL_c`, `TG` (mmol/L).
- Optional when present/mapped: `LDL_c` (mmol/L), `ApoB`, `ApoA1`, `waist` (cm), `BMI` (kg/m^2), `glucose` (mmol/L; needed for TyG-BMI).
- Use `col_map` to rename; numeric-like inputs are coerced and non-finite set to `NA` before policies.

## Core calculation

```{r}
lm_out <- lipid_markers(
  data = lipids,
  col_map = list(
    TC = "TC", HDL_c = "HDL_c", TG = "TG", LDL_c = "LDL_c",
    ApoB = "ApoB", ApoA1 = "ApoA1", waist = "waist", BMI = "BMI", glucose = "glucose"
  ),
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)
lm_out |> slice_head(n = 5)
```

## Missing data & extremes

- `na_action`: `keep/ignore` retain rows with missing inputs (derived outputs become `NA`); `omit` drops them; `error` aborts; `warn` retains with warnings. `na_warn_prop` flags high missingness when warning.
- `check_extreme` with `extreme_action` (`warn`, `cap`, `NA`, `error`, `ignore`) scans broad defaults (TC/HDL/TG/LDL 0-50 mmol/L; ApoB/ApoA1 0-10; waist 30-250 cm; BMI 10-80 kg/m^2; glucose 0-50 mmol/L). Override via `extreme_rules`.
- If `LDL_c` is absent, LDL is estimated via Friedewald (TC - HDL - TG/5) when TG is available.

## Expectations

- Outputs: `non_HDL_c`, `remnant_c`, `ratio_TC_HDL`, `ratio_TG_HDL`, `ratio_LDL_HDL`, `ApoB_ApoA1` (needs ApoB & ApoA1), `VAI_Men/Women` (needs waist & BMI), `LAP_Men/Women` (needs waist), `TyG_BMI` (needs glucose & BMI).
- Units follow inputs; TyG-BMI converts TG/glucose to mg/dL internally.

## Tips

- Provide waist and BMI to enable VAI/LAP; supply glucose and BMI to enable TyG-BMI.
- Use `check_extreme = TRUE` with `cap` to bound implausible lipid or anthropometric values.
- Set `na_action = "omit"` when you need complete-case derived lipid indices.

## Missing-data policy

```{r}
missing <- lipids
missing$TG[4] <- NA

lipid_markers(
  data = missing,
  col_map = list(TC = "TC", HDL_c = "HDL_c", TG = "TG", LDL_c = "LDL_c", BMI = "BMI"),
  na_action = "omit"
)

lipid_markers(
  data = missing,
  col_map = list(TC = "TC", HDL_c = "HDL_c", TG = "TG", LDL_c = "LDL_c", BMI = "BMI"),
  na_action = "warn"
)
```

## Tips

- Map columns explicitly when dataset names differ (e.g., `col_map = list(TC = "TotalChol", HDL_c = "HDL", TG = "Trig")`).
- Supply both ApoB and ApoA1 to get `ApoB_ApoA1`; otherwise that column is `NA`.
- Provide waist and BMI to unlock VAI/LAP; provide glucose and BMI to unlock TyG-BMI.
- Tighten `extreme_rules` to match assay limits before using `extreme_action = "cap"` or `"error"`.
- When LDL-C is missing, Friedewald is used; avoid very high TG (>11.3 mmol/L) where the estimate is unreliable.