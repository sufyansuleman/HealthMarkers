---
title: "Infer Column Names"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{infer_cols}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(purl = FALSE)
```

## Scope
Map your dataâ€™s column names to the keys expected by HealthMarkers functions. `infer_cols()` uses regex (and optional fuzzy) matching with tie-break strategies, preferences, and logging; defaults are strict and error on missing/ambiguous matches. `hm_infer_cols()` is the internal exact-name helper used when package functions infer columns automatically.

## When to use
- You want deterministic column matching (with clear logs) before running calculators.
- You need graceful handling of messy schemas: prefer/tie-break/fuzzy options to resolve synonyms or typos.
- You plan to pass a resolved `col_map` into aggregators (e.g., `all_health_markers()`) to avoid re-inference surprises.

## Inputs and options (quick reference)
- `data`: data.frame/tibble whose column names you want to map.
- `map`: named list of keys -> column names; set values to `NULL` to infer.
- `strategy`: `error` (abort on ambiguity/missing), `prefer` (honor `prefer`, then stable), `first` (data order), `stable` (shortest then alphabetical).
- `strict`: if `TRUE`, error on unresolved keys; if `FALSE`, leave them `NULL` with warnings.
- `fuzzy`/`max_distance`: enable fuzzy fallback when regex finds nothing; off by default.
- `prefer`: optional exact-name hints to break ties deterministically.
- `return`: `map` or `list` (map + log); `log_file` writes a human-readable log.
- `hm_infer_cols()`: internal exact-name helper used by aggregators when `col_map` is missing.

## Demo Data
Small tibble with column names that need mapping to fasting glucose/insulin and lipids.

```{r}
library(HealthMarkers)
library(tibble)

df <- tibble(
  fasting_glucose = c(5.5, 6.1),
  fasting_insulin = c(60, 88),
  TG = c(120, 150),
  `HDL-c` = c(50, 45),
  age = c(55, 60)
)

map_spec <- list(G0 = NULL, I0 = NULL, TG = NULL, HDL_c = NULL)
```

## Core Inference (Strict)
Backward-compatible behavior: strict + error strategy aborts on missing/ambiguous matches.

```{r}
infer_cols(df, map_spec, verbose = FALSE)
```

## Resolve Ties with Preferences
Use preferred names and a stable tie-break to choose deterministically when multiple candidates match.

```{r}
infer_cols(
  data = df,
  map = map_spec,
  strategy = "prefer",
  prefer = list(HDL_c = c("HDL-c", "HDL")),
  verbose = TRUE
)
```

## Allow Fuzzy Fallback
Enable fuzzy matching when names are noisy; cap distance with `max_distance`.

```{r}
infer_cols(
  data = df,
  map = map_spec,
  fuzzy = TRUE,
  max_distance = 0.15,
  strict = FALSE,    # leave unresolved keys as NULL instead of error
  strategy = "stable",
  verbose = TRUE
)
```

## Capture Log for Auditing
Return the map plus a decision log and optionally write it to disk.

```{r}
log_path <- tempfile(fileext = ".log")

res <- infer_cols(
  data = df,
  map = map_spec,
  strategy = "prefer",
  prefer = list(HDL_c = c("HDL-c", "HDL")),
  return = "list",
  log_file = log_path,
  verbose = TRUE
)

res$map
head(res$log)
#log_path
```

## Expectations and When to Use/Avoid
- Use strict + `error` when you want early failures for required inputs (e.g., before running marker calculators).
- Use `prefer` or `stable` when you expect multiple synonyms and want deterministic choices without errors.
- Enable `fuzzy` only when column names are noisy/typo-prone; keep `max_distance` small to avoid bad matches.
- Set `strict = FALSE` if partial mappings are acceptable; unresolved keys remain `NULL` and must be handled before computation.
- Avoid fuzzy matching on very small or already clean schemas; prefer explicit `col_map` in production pipelines.

## Tips
- Start with `verbose = TRUE` while iterating on mappings, then turn it off in production.
- Save the inferred `col_map` in your scripts once settled to avoid surprises when column names change.
- Feed the resolved map into `all_health_markers()` or other helpers to bypass re-inference.

