---
title: "frax_score"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{frax_score}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`frax_score()` provides a simplified, non-validated approximation of FRAX 10-year fracture risk (major osteoporotic and hip) from FRAX-like risk factors. It normalizes sex labels, handles optional BMD T-scores, applies HM-CS NA/extreme policies, and returns NA rows when inputs are incomplete (unless omitted). Optional extreme screening can warn, cap, blank, or error on age/BMD outside plausible ranges.

## Inputs

- `data`: data.frame/tibble with at least age and sex.
- `col_map`: named list with `age` and `sex` (defaults: `Age`, `Sex`). Optional keys: `prior_fracture`, `parent_fracture`, `steroids`, `rheumatoid`, `secondary_op`, `smoker`, `alcohol`, `bmd` (T-score).
- Sex codes are normalized from first letter (`m`/`f`) or `1`/`0`; unknown codes yield NA and warn.
- Numeric-like columns are coerced; non-finite values become `NA`.

## Arguments

- `na_action = c("keep","omit","error","ignore","warn")`: missing-data policy (`ignore`/`warn` behave like `keep`).
- `check_extreme = FALSE`: enable range scan (age, BMD).
- `extreme_action = c("warn","cap","error","ignore","NA")`: response to extremes (`cap` trims to bounds; `NA` blanks values).
- `extreme_rules = NULL`: override default bounds (age 40–90, BMD T -6 to 2).
- `country = NULL`: accepted but unused placeholder.
- `verbose = FALSE`: emit progress via `inform`/`hm_inform`.

## Output

Returns a tibble with `frax_major_percent`, `frax_hip_percent`, plus `frax_sex_norm`, `frax_age_used`, `frax_bmd_tscore`. With `na_action = "omit"`, rows missing required inputs are dropped; otherwise they produce `NA` outputs. This is a placeholder estimator, not the proprietary FRAX algorithm.

## Examples

```{r}
library(HealthMarkers)
library(tibble)

demo <- tibble(
  Age = c(65, 72), Sex = c("F", "M"),
  prior_fx = c(1, 0), parent_fx = c(0, 1), steroids = c(0, 1),
  rheumatoid = c(0, 0), secondary = c(0, 0), smoker = c(0, 1), alcohol = c(1, 0),
  bmd = c(-2.0, -1.0)
)

frax_score(
  data = demo,
  col_map = list(
    age = "Age", sex = "Sex",
    prior_fracture = "prior_fx", parent_fracture = "parent_fx",
    steroids = "steroids", rheumatoid = "rheumatoid", secondary_op = "secondary",
    smoker = "smoker", alcohol = "alcohol", bmd = "bmd"
  ),
  na_action = "keep",
  check_extreme = TRUE,
  extreme_action = "warn",
  verbose = FALSE
)
```

## Examples

Drop rows with missing required inputs and cap age/BMD into bounds:

```{r}
frax_score(
  data = demo,
  col_map = list(age = "Age", sex = "Sex", bmd = "bmd"),
  na_action = "omit",
  check_extreme = TRUE,
  extreme_action = "cap",
  extreme_rules = list(age = c(45, 90), bmd_t = c(-5, 1)),
  verbose = TRUE
)
```

## Notes

- This is a simplified placeholder and not a substitute for official FRAX calculators.
- `na_action = "error"` enforces complete age/sex; `"omit"` drops incomplete rows; `"keep"`/`"warn"` retain rows with NA outputs.
- Extreme screening supports warn/cap/NA/error behaviors; defaults: age 40–90, BMD T -6 to 2.
- Sex normalization accepts leading `m`/`f` or `1`/`0`; unknown codes are set to NA with a warning.
