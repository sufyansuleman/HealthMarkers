---
title: "obesity_indices"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{obesity_indices}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`obesity_indices()` computes anthropometric adiposity/shape indices: BMI (with WHO category), WHR (and optional WHRadjBMI), WHtR, AVI, BAI, ABSI, BRI, Conicity Index, waist/BMI and weight/height ratios, and optionally Relative Fat Mass (RFM). It handles unit conversion for weight (kg/lb) and height (m/cm), supports NA policies, optional extreme scanning with warn/cap/error behaviors, and verbose summaries. Inputs must already be in the specified units; no other conversions are performed.

## Required Inputs

- `data`: data.frame/tibble with columns for weight, height, waist, hip (numeric). Sex column is required only if `include_RFM = TRUE` (coded 0=male, 1=female).
- Column arguments are unquoted column names: `weight`, `height`, `waist`, `hip`, and optional `sex`.
- Units: weight kg (or lb if `weight_unit = "lb"`), height m (or cm if `height_unit = "cm"`), waist/hip cm.

## Key Arguments

- `weight_unit = c("kg","lb")`, `height_unit = c("cm","m")`: controls unit conversion to kg/m.
- `adjust_WHR = FALSE`: add BMI-adjusted WHR residuals.
- `include_RFM = FALSE`: compute Relative Fat Mass (requires `sex`).
- `na_action = c("keep","omit","error")`: missing-data policy for required inputs (`omit` drops rows; `error` aborts).
- `na_warn_prop = 0.2`: high-missingness warning threshold (debug-level messaging).
- `check_extreme = FALSE`: enable range scan on weight_kg/height_m/waist/hip.
- `extreme_action = c("warn","cap","error","ignore")`: handling for extremes when scanning (`cap` truncates; `warn` messages; `error` aborts; `ignore` no-op).
- `extreme_rules = NULL`: override defaults (weight_kg 20–400; height_m 1.2–2.5; waist 30–200 cm; hip 30–200 cm).
- `verbose = FALSE`: emit progress and completion summaries.

## Output Description

Returns the input data with added columns: `weight_kg`, `height_m`, `BMI`, `BMI_cat`, `WHR`, `waist_to_height_ratio`, `AVI`, `BAI`, `ABSI`, `BRI`, `CI`, `waist_to_BMI_ratio`, `weight_to_height_ratio`, optional `WHRadjBMI`, and optional `RFM`. Zero denominators are warned and yield `NA`; WHRadjBMI requires finite WHR/BMI variance; RFM requires sex coded 0/1.

## Minimal Reproducible Example

```{r}
library(HealthMarkers)
library(tibble)

df <- tibble(
  wt    = c(70, 80),   # kg
  ht    = c(175, 165), # cm
  waist = c(80, 90),   # cm
  hip   = c(100, 95),  # cm
  sex   = c(0, 1)
)

obesity_indices(
  data = df,
  weight = wt,
  height = ht,
  waist = waist,
  hip = hip,
  sex = sex,
  weight_unit = "kg",
  height_unit = "cm",
  adjust_WHR = TRUE,
  include_RFM = TRUE,
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)
```

## Extended Example

Scan for extremes with capping and verbose summary, omitting rows with missing inputs:

```{r}
obesity_indices(
  data = df,
  weight = wt,
  height = ht,
  waist = waist,
  hip = hip,
  sex = sex,
  weight_unit = "kg",
  height_unit = "cm",
  adjust_WHR = FALSE,
  include_RFM = TRUE,
  na_action = "omit",
  check_extreme = TRUE,
  extreme_action = "cap",
  verbose = TRUE
)
```

## Notes / Workflow Integration

- Required columns must be numeric; sex must be numeric 0/1 when `include_RFM = TRUE`.
- WHRadjBMI is computed only when WHR and BMI have finite variance; otherwise it is set to `NA` with a warning.
- Extreme screening uses broad heuristics; adjust `extreme_rules` for cohort-specific plausibility.
- BMI categories use standard WHO cut points; units are normalized internally to kg/m before calculations.