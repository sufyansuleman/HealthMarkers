---
title: "Impute missing data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{impute_missing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(purl = FALSE)
```

## Scope
Deterministic numeric imputation (`impute_missing()`) plus optional advanced methods (`impute_mice()`, `impute_missforest()`). All helpers restrict to numeric columns, preserve non-NA values, and keep data dimensions unchanged. Use this as a pre-flight step before computing markers.

## Load packages and demo data
Create a small tibble with missing values in numeric columns; keep a non-numeric column to show it is untouched.

```{r}
library(HealthMarkers)
library(tibble)
library(dplyr)

demo <- tibble(
  BMI = c(22, NA, 27, 25),
  TG = c(1.4, 1.6, NA, 1.3),
  HDL_c = c(1.1, NA, 1.3, 1.0),
  group = factor(c("A", "A", "B", "B"))
)

demo
```

## Core imputation
Impute numeric columns with the mean. Non-numeric columns remain unchanged.

```{r}
imp_mean <- impute_missing(demo, method = "mean", verbose = FALSE)
imp_mean
```

Use a different strategy and restrict to selected columns.

```{r}
imp_const <- impute_missing(demo, method = "constant", constant = -1, cols = c("TG", "HDL_c"))
imp_const
```

## Missingness warnings
Columns with high missingness (>= `na_warn_prop`, default 20%) emit warnings when verbose/diagnostic modes are used.

```{r}
imp_warn <- impute_missing(demo, method = "median", na_warn_prop = 0.2, verbose = TRUE)
imp_warn
```

## Advanced options (conditional)
Multiple imputation and random-forest imputation run only if the packages are installed. Each requires at least two numeric columns with NAs.

```{r}
if (requireNamespace("mice", quietly = TRUE)) {
  mice_out <- tryCatch(
    impute_mice(demo, m = 2, verbose = TRUE),
    error = function(e) {
      message("mice skipped on tiny demo: ", e$message)
      NULL
    }
  )
  mice_out
} else {
  message("Install 'mice' to run impute_mice().")
}

if (requireNamespace("missForest", quietly = TRUE)) {
  mf_out <- tryCatch(
    impute_missforest(demo, ntree = 50, verbose = TRUE),
    error = function(e) {
      message("missForest skipped on tiny demo: ", e$message)
      NULL
    }
  )
  mf_out
} else {
  message("Install 'missForest' to run impute_missforest().")
}
```

## Inputs and options
- `data`: data.frame/tibble; only numeric columns are imputed.
- `method` (impute_missing): `mean`, `median`, `zero`, or `constant` (requires `constant`).
- `cols`: optional subset to impute; defaults to all numeric columns with NAs.
- `na_warn_prop`: per-column high-missingness threshold for warnings (impute_missing).
- `m` (mice), `ntree` (missForest): control complexity for advanced methods; both require their respective packages and >= 2 numeric columns with NAs.
- `verbose`: emit progress and counts.

## Behavior and expectations
- Non-numeric columns are ignored; input dimensions are preserved.
- NA positions only are filled; non-NA values stay unchanged.
- If no eligible numeric columns with NAs are found, the input is returned.
- `impute_mice()`/`impute_missforest()` abort when prerequisites (packages, columns with NAs) are not met; missForest falls back to mean imputation if its model fails.

## Choosing a method (use vs avoid)
- `impute_missing()` (mean/median/zero/constant): best for fast, transparent fills or when you need deterministic behavior for testing. Avoid for highly skewed variables if mean/zero would bias results; use `median` or a domain-appropriate `constant` instead.
- `impute_mice()`: use when you have several numeric predictors and want uncertainty-aware, model-based fills. Avoid on tiny datasets or when columns are collinear/constant—mice will skip or fail; keep at least 2-3 informative numeric columns with NAs.
- `impute_missforest()`: use for non-linear relationships and mixed patterns of missingness. Avoid on very small or extremely wide datasets if runtime is a concern; it needs >=2 numeric columns with NAs and may fall back to mean if the RF model cannot fit.
- Do not impute derived markers you plan to drop; impute raw inputs first, then recompute markers.

## When not to impute
- Do not impute identifiers, categorical codes, or outcomes you will model—restrict imputation to predictors and numeric labs.
- If missingness is structural (e.g., test not ordered), prefer leaving `NA` or removing rows rather than filling synthetic values.
- For extreme missingness in a column (>80-90%), consider dropping the column instead of imputing; the fill will be guesswork.

## Tips
- Start with `impute_missing()` for quick, transparent fills; move to `mice`/`missForest` when you need model-based imputations.
- Check outputs with `health_summary()` to confirm row counts and missingness after imputation.
- Keep units consistent before imputing and before downstream marker calculations.

