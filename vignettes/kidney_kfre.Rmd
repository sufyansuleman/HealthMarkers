---
title: "kidney_failure_risk"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{kidney_failure_risk}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`kidney_failure_risk()` implements the 4-variable Kidney Failure Risk Equation (KFRE) for 2- and 5-year ESKD risk. It includes NA policies, optional high-missingness warnings, optional extreme screening with warn/cap/NA/error behaviors, and verbose summaries. Inputs are assumed in KFRE units: age (years), sex coded 1=male/2=female, eGFR (mL/min/1.73 m^2), UACR (mg/g); no unit conversion is done.

## Required Inputs

- `data`: data.frame/tibble with KFRE predictors.
- `col_map`: named list mapping `age`, `sex`, `eGFR`, `UACR` (defaults: same names). All four mappings are required and columns must exist.
- `sex` must be numeric/integer coded 1=male, 2=female.
- Numeric columns must be numeric; non-finite values remain NA unless handled by policies.

## Key Arguments

- `na_action = c("keep","error","omit","warn")`: missing-data policy (`keep` propagates NA; `omit` drops rows; `error` aborts; `warn` retains rows with warnings).
- `na_warn_prop = 0.2`: threshold for high-missingness warnings when `na_action = "warn"`.
- `check_extreme = FALSE`: enable plausible-range scan (age/eGFR/UACR).
- `extreme_action = c("warn","cap","error","ignore","NA")`: response to extremes when scanning (`cap` truncates; `NA` blanks values).
- `extreme_rules = NULL`: override default bounds (age 18–120, eGFR 1–200, UACR 0.1–10000 mg/g).
- `verbose = FALSE`: emit progress and completion stats.

## Output Description

Returns a tibble with `KFRE_2yr` and `KFRE_5yr` risks (0–1). With `na_action = "omit"`, rows with missing required inputs are dropped; otherwise those rows produce `NA` risks. Extreme handling can cap or blank inputs before risk calculation.

## Minimal Reproducible Example

```{r}
library(HealthMarkers)
library(tibble)

df <- tibble(
  age  = c(65, 72),
  sex  = c(1, 2),
  eGFR = c(45, 22),
  UACR = c(300, 1200)
)

kidney_failure_risk(
  data = df,
  col_map = list(age = "age", sex = "sex", eGFR = "eGFR", UACR = "UACR"),
  na_action = "keep",
  check_extreme = FALSE,
  verbose = FALSE
)
```

## Extended Example

Cap extremes and warn, keeping all rows:

```{r}
kidney_failure_risk(
  data = df,
  col_map = list(age = "age", sex = "sex", eGFR = "eGFR", UACR = "UACR"),
  na_action = "warn",
  check_extreme = TRUE,
  extreme_action = "cap",
  verbose = TRUE
)
```

## Notes / Workflow Integration

- `sex` must be coded 1/2; invalid codes abort.
- `na_action = "error"` enforces complete predictors; `omit` filters; `keep`/`warn` retain NA risks.
- Extreme screening uses broad defaults; adjust `extreme_rules` if your cohort spans different ranges.
- Logs require positive eGFR and UACR; warnings are issued for non-positive values.