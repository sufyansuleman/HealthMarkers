---
title: "Adipose insulin sensitivity indices"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{adipo_is}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(purl = FALSE)
```

## Scope
Fasting adipose insulin sensitivity/resistance indices in one call: Revised_QUICKI, McAuley_index, Adipo_inv, Belfiore_inv_FFA, TyG_inv, TG_HDL_C_inv, and sex-specific VAI/LAP (inverted so more negative = worse). Inputs are fasting; common glucose/insulin/TG/HDL unit conversions are handled internally.

## When to use this
- You need multiple adipose IR markers for metabolic phenotyping or clustering.
- You have fasting glucose, insulin, lipids, and adiposity (waist/BMI); sex is optional but improves VAI/LAP labeling.
- You want built-in plausibility screening and NA policy controls.

## What you need
- Required columns: `G0` (mmol/L), `I0` (pmol/L), `TG` (mmol/L), `HDL_c` (mmol/L), `FFA` (mmol/L), `waist` (cm), `bmi` (kg/m^2).
- Fasting values only; post-prandial inputs will misstate IR.
- Units before conversion: glucose mmol/L, insulin pmol/L, TG mmol/L, HDL mmol/L, FFA mmol/L, waist cm, BMI kg/m^2. If different, convert first.
- Optional but helpful: `sex` (1/2 or labels) to understand which VAI/LAP variant applies.

## Load packages and data
Use a small subset of the simulated data. Swap `sim_small` for your own data.

```{r}
library(HealthMarkers)
library(dplyr)

sim_path <- system.file("extdata", "simulated_hm_data.rds", package = "HealthMarkers")
sim <- readRDS(sim_path)
sim_small <- sim[1:50, ]
```

## Column map
Map required inputs; left-hand keys are fixed.

```{r}
col_map <- list(
  G0 = "G0",
  I0 = "I0",
  TG = "TG",
  HDL_c = "HDL_c",
  FFA = "FFA",
  waist = "waist",
  bmi = "BMI"
)
```

## Walkthrough (compute and read results)

```{r}
ais <- adipo_is(
  data = sim_small,
  col_map = col_map,
  na_action = "keep",
  check_extreme = FALSE,
  normalize = "none"
)

ais |>
  slice_head(n = 5) |>
  select(Revised_QUICKI, TyG_inv, TG_HDL_C_inv, VAI_Men_inv, VAI_Women_inv, LAP_Men_inv, LAP_Women_inv)
```

Reading the outputs: values ending in `_inv` are inverted so more negative indicates worse adipose IR. Only one of each sex-specific pair (VAI/LAP) is meaningful per subject depending on sex.

## Missing data and extremes
Screen a small slice, cap extremes, and compare row handling.

```{r}
demo <- sim_small[1:6, c("G0", "I0", "TG", "HDL_c", "FFA", "waist", "BMI")]
demo$G0[2] <- NA        # missing glucose
demo$TG[3] <- 30        # extreme TG (mmol/L)

ais_keep <- adipo_is(
  data = demo,
  col_map = col_map,
  na_action = "keep",
  check_extreme = TRUE,
  extreme_action = "cap",
  normalize = "none",
  verbose = FALSE
)

ais_omit <- adipo_is(
  data = demo,
  col_map = col_map,
  na_action = "omit",
  check_extreme = TRUE,
  extreme_action = "cap",
  normalize = "none",
  verbose = FALSE
)

list(
  keep_rows = nrow(ais_keep),
  omit_rows = nrow(ais_omit),
  capped_preview = ais_keep |> select(ends_with("_inv")) |> slice_head(n = 3)
)
```

## Expectations
- All seven required mappings must be provided; missing mappings or columns abort.
- `na_action` controls row handling: `keep` propagates NA outputs; `omit` drops rows with missing required inputs; `error` aborts.
- `check_extreme` screens raw inputs before conversion; `extreme_action` can warn, cap, NA, or error.
- Built-in conversions: glucose *18 (mg/dL), insulin /6 (muU/mL), TG *88.57 (mg/dL), HDL *38.67 (mg/dL); FFA/waist/BMI unchanged.

## Common pitfalls
- Non-fasting samples inflate TG/glucose and distort TyG/VAI/LAP.
- Mis-specified units (e.g., mg/dL glucose without converting) will skew every index; convert upstream if your lab units differ.
- Missing `sex` does not block computation but only one of VAI/LAP applies per subject; interpret accordingly.
- If you need z/min-max scaling for modeling, set `normalize`; default `none` returns raw-index scales.

## Validation notes
- Scan distributions: TyG_inv around -8 to -12 for typical adults; more negative suggests worse IR. Revised_QUICKI ~0.2â€“0.7; lower is worse.
- Spot-check a few rows manually (e.g., TG_HDL_C_inv should equal `-(TG/HDL)` after conversions).
- Use `check_extreme = TRUE` with lab-appropriate `extreme_rules` before capping or erroring.

## See also
- `glycemic_markers()` for glucose-centric indices.
- `insulin_secretion()` and `insulin_sensitivity()` vignettes for complementary beta-cell metrics.
