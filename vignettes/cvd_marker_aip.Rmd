---
title: "CVD Marker AIP"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cvd_marker_aip}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(purl = FALSE)
```

## Scope
Compute the Atherogenic Index of Plasma (AIP) as $\log_{10}(\mathrm{TG} / \mathrm{HDL}_c)$ with explicit column mapping, numeric coercion, and NA policies.

## When to use
- You have triglycerides and HDL-c in mg/dL and need a fast atherogenicity marker.
- You want consistent NA handling (keep/omit/error) across analytic pipelines.
- Your source column names differ from the defaults `TG` and `HDL_c`.

## Inputs and requirements
- `data`: data.frame/tibble containing TG and HDL-c.
- `col_map`: named list mapping `TG` and `HDL_c` to column names in `data`.
- Units: mg/dL (no unit conversion performed).
- Non-finite values are treated as missing before NA handling.

## Load packages and data
Use a 30-row slice of the simulated data with native `TG` and `HDL_c` columns.

```{r}
library(HealthMarkers)
library(dplyr)

sim_path <- system.file("extdata", "simulated_hm_data.rds", package = "HealthMarkers")
sim <- readRDS(sim_path)
sim_small <- sim[1:30, c("TG", "HDL_c")]

col_map <- list(TG = "TG", HDL_c = "HDL_c")
```

## Quick start
Compute AIP with defaults and preview the first rows.

```{r}
aip_out <- cvd_marker_aip(
  data = sim_small,
  col_map = col_map,
  na_action = "keep",
  verbose = FALSE
)

head(aip_out)
```

## Column mapping
Map alternate column names. Here we rename to show `col_map` flexibility.

```{r}
sim_renamed <- sim_small |> rename(tg_lab = TG, hdl_lab = HDL_c)

aip_mapped <- cvd_marker_aip(
  data = sim_renamed,
  col_map = list(TG = "tg_lab", HDL_c = "hdl_lab")
)

head(aip_mapped)
```

## Missing data handling
Compare retaining vs omitting rows with missing inputs. Insert an `NA` so `na_action = "omit"` drops the affected row.

```{r}
demo <- as.data.frame(sim_small[1:8, ])
demo[["TG"]][3] <- NA

aip_keep <- cvd_marker_aip(demo, col_map, na_action = "keep")
aip_omit <- cvd_marker_aip(demo, col_map, na_action = "omit")

list(keep_rows = nrow(aip_keep), omit_rows = nrow(aip_omit))
```

Use `na_action = "error"` to abort when any required input is missing or non-finite.

## Numeric coercion
Non-numeric inputs are coerced to numeric with a warning; any non-finite results become `NA` before NA handling.

```{r}
ch <- sim_small |> mutate(TG = as.character(TG), HDL_c = as.character(HDL_c))

aip_coerced <- cvd_marker_aip(ch, col_map)
head(aip_coerced)
```

## Outputs
- Tibble with columns `model = "AIP"` and `value` (the log10 ratio).
- Rows are dropped only when `na_action = "omit"`; otherwise `value` is `NA` where inputs are missing or non-finite.

## Tips
- For clean slices of data, set `na_action = "keep"`; for modeling pipelines, prefer `"omit"` or `"error"` to avoid silent gaps.
- Pre-check units if your source is in mmol/L to avoid scale errors (no conversion performed).
- Because computation is per-row, you can safely bind `cvd_marker_aip()` output back to your data via `bind_cols()`.
