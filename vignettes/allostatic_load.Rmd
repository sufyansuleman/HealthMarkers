---
title: "allostatic_load"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{allostatic_load}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE)
knitr::opts_knit$set(purl = FALSE)
```

## Overview

`allostatic_load()` sums high-risk flags across biomarkers using user-specified thresholds. With multiple biomarkers, flags are `> threshold`; with a single biomarker, the rule is `>= threshold`. Optional SDS-like extreme screening applies to columns whose names contain "sds".

## Inputs

- `data`: data.frame/tibble with numeric biomarker columns.
- `thresholds`: named list of scalar numeric cut-points; names must match columns (or mapped names).
- `col_map` (optional): map threshold names to column names; defaults to identity.
- Inputs are coerced to numeric; non-finite become `NA`.

## Arguments

- `na_action = c("keep","omit","error")`: row-wise policy for mapped inputs (`keep` treats NA as 0 contribution).
- `check_extreme = FALSE`: scan columns whose names contain "sds" for |value| > `sds_limit`.
- `extreme_action = c("cap","NA","error")`: handling of SDS-like extremes when screening is enabled.
- `sds_limit = 6`: absolute SDS limit for screening.
- `return_summary = FALSE`: if TRUE, return list with data, summary, warnings.
- `verbose`: emit progress messages.

## Output

Returns a tibble with `AllostaticLoad` (integer sum of flags). With `return_summary = TRUE`, returns list with `data`, `summary` (rows, biomarkers, totals), and `warnings`. Rows drop only when `na_action = "omit"`; otherwise missing inputs propagate `NA` flags but still sum available indicators.

## Examples

```{r}
library(HealthMarkers)
library(tibble)

df <- tibble(
  SBP = c(118, 142, 130),
  DBP = c(76, 92, 85),
  CRP = c(1.2, 4.8, 2.1)
)

thr <- list(SBP = 130, DBP = 85, CRP = 3)

allostatic_load(
  data = df,
  thresholds = thr,
  na_action = "keep",
  check_extreme = FALSE,
  extreme_action = "cap",
  verbose = FALSE
)
```

## Examples

Drop incomplete rows, scan SDS-like columns for extremes, and cap them:

```{r}
allostatic_load(
  data = df,
  thresholds = thr,
  na_action = "omit",
  check_extreme = TRUE,
  extreme_action = "cap",
  sds_limit = 6,
  return_summary = TRUE,
  verbose = TRUE
)
```

## Notes

- Threshold list names must align with columns (or mapped via `col_map`); duplicates or empty names abort.
- With one biomarker, the flag rule is `>= threshold`; otherwise `> threshold`.
- SDS-like screening touches only columns whose names include "sds"; adjust `sds_limit` if your SDS scale differs.
- `na_action = "error"` enforces completeness; `"omit"` drops incomplete rows; `"keep"` retains them with NA contributions.

